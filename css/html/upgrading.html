<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd"><html xmlns="http://www.w3.org/1999/xhtml"><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8" /><title>18.6. PostgreSQLクラスタのアップグレード処理</title><link rel="stylesheet" type="text/css" href="stylesheet.css" /><link rev="made" href="pgsql-docs@lists.postgresql.org" /><meta name="generator" content="DocBook XSL Stylesheets V1.79.1" /><link rel="prev" href="server-shutdown.html" title="18.5. サーバのシャットダウン" /><link rel="next" href="preventing-server-spoofing.html" title="18.7. サーバのなりすまし防止" /><meta name="viewport" content="width=device-width,initial-scale=1.0" /></head><body><div class="navheader"><table width="100%" summary="Navigation header"><tr><th colspan="4" align="center"><a accesskey="h" href="index.html">PostgreSQL 11.4文書</a></th></tr><tr><td width="10%" align="left"></td><td width="10%" align="left"></td><td width="60%" align="center"><a href="runtime.html" title="第18章 サーバの準備と運用">第18章 サーバの準備と運用</a></td><td width="20%" align="right"></td></tr><tr><td width="10%" align="left"><a accesskey="p" href="server-shutdown.html" title="18.5. サーバのシャットダウン">前へ</a> </td><td width="10%" align="left"><a accesskey="u" href="runtime.html" title="第18章 サーバの準備と運用">上へ</a></td><td width="60%" align="center">18.6. <span class="productname">PostgreSQL</span>クラスタのアップグレード処理</td><td width="20%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html" title="18.7. サーバのなりすまし防止">次へ</a></td></tr></table><hr /></div><div class="sect1" id="UPGRADING"><div class="titlepage"><div><div><h2 class="title" style="clear: both">18.6. <span class="productname">PostgreSQL</span>クラスタのアップグレード処理</h2></div></div></div><!--
  <title>Upgrading a <productname>PostgreSQL</productname> Cluster</title>
--><a id="id-1.6.5.8.2" class="indexterm"></a><a id="id-1.6.5.8.3" class="indexterm"></a><p>
<!--
   This section discusses how to upgrade your database data from one
   <productname>PostgreSQL</productname> release to a newer one.
-->
本節では<span class="productname">PostgreSQL</span>リリースからより新しいリリースにデータベースデータをアップグレードする方法を説明します。
  </p><p>
<!--
   Current <productname>PostgreSQL</productname> version numbers consist of a
   major and a minor version number.  For example, in the version number 10.1,
   the 10 is the major version number and the 1 is the minor version number,
   meaning this would be the first minor release of the major release 10.  For
   releases before <productname>PostgreSQL</productname> version 10.0, version
   numbers consist of three numbers, for example, 9.5.3.  In those cases, the
   major version consists of the first two digit groups of the version number,
   e.g., 9.5, and the minor version is the third number, e.g., 3, meaning this
   would be the third minor release of the major release 9.5.
-->
現在の<span class="productname">PostgreSQL</span>メジャーバージョンとマイナーバージョンのバージョン番号で構成されます。
例えばバージョン番号は10.1は、10がメジャーバージョンで、1がマイナーバージョンです。メジャーリリース10の最初のマイナーリリースを意味します。
<span class="productname">PostgreSQL</span>の10.0より前のバージョンは, ３つの番号で構成されています。例えば9.5.3です。
この場合は、最初のメジャーバージョンが２つのグループのバージョン番号、例えば9.5で構成されています。
そしてマイナーバージョンは３つ目の番号で例えば3です。これはメジャーリリース9.5の３番めのマイナーリリースを意味します。
  </p><p>
<!--
   Minor releases never change the internal storage format and are always
   compatible with earlier and later minor releases of the same major version
   number.  For example, version 10.1 is compatible with version 10.0 and
   version 10.6.  Similarly, for example, 9.5.3 is compatible with 9.5.0,
   9.5.1, and 9.5.6.  To update between compatible versions, you simply
   replace the executables while the server is down and restart the server.
   The data directory remains unchanged &mdash; minor upgrades are that
   simple.
-->
マイナーリリースでは内部格納書式が変わることは決してありませんので、同じメジャーバージョンにおける前後のマイナーリリースとの間で常に互換性があります。
例えばバージョン10.1はバージョン10.0やバージョン10.6と互換性があります。
同様に、例えば9.5.3は9.5.0、9.5.1、9.5.6と互換性があります
互換性があるバージョンとの間で更新するためには、サーバを停止させ、実行ファイルを置き換え、サーバを再起動させるだけです。
データディレクトリはまったく変更されません。
マイナーリリースのアップグレードは簡単です。
  </p><p>
<!--
   For <emphasis>major</emphasis> releases of <productname>PostgreSQL</productname>, the
   internal data storage format is subject to change, thus complicating
   upgrades.  The traditional method for moving data to a new major version
   is to dump and reload the database, though this can be slow.  A
   faster method is <xref linkend="pgupgrade"/>.  Replication methods are
   also available, as discussed below.
-->
<span class="productname">PostgreSQL</span>の<span class="emphasis"><em>メジャー</em></span>リリースでは、内部データ格納書式は変更されがちです。
したがって、アップグレードは複雑になります。
新しいメジャーバージョンにデータを移行する伝統的な方法は、遅くなることがありますが、データベースをダンプしてリロードすることです。より速い方法については、<a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a>を参照してください。以下で説明するようにレプリケーションを使用する方法もあります。
  </p><p>
<!--
   New major versions also typically introduce some user-visible
   incompatibilities, so application programming changes might be required.
   All user-visible changes are listed in the release notes (<xref
   linkend="release"/>);  pay particular attention to the section
   labeled "Migration".  If you are upgrading across several major
   versions, be sure to read the release notes for each intervening
   version.
-->
新しいメジャーバージョンは通常、ユーザにも影響する非互換性がいくつか導入されます。
このためアプリケーションのプログラム変更が必要になる可能性があります。
ユーザに影響する変更はすべてリリースノート（<a class="xref" href="release.html" title="付録E リリースノート">付録E</a>）に列挙されています。
「移行」という名前の節に特に注意してください。
複数のメジャーバージョンをまたいでアップグレードする場合は、関連するバージョンそれぞれのリリースノートを確認してください。
  </p><p>
<!--
   Cautious users will want to test their client applications on the new
   version before switching over fully; therefore, it's often a good idea to
   set up concurrent installations of old and new versions.  When
   testing a <productname>PostgreSQL</productname> major upgrade, consider the
   following categories of possible changes:
-->
用心深いユーザは、完全に切り替える前に新しいバージョンにおける自身のクライアントアプリケーションを試験したいと考えるでしょう。
このため古いバージョンと新しいバージョンを並行してインストールさせるというのは、よく良い考えとなります。
<span class="productname">PostgreSQL</span>メジャーアップグレードを試験する時、以下に示す変更があり得る分野を検討してください。
  </p><div class="variablelist"><dl class="variablelist"><dt><span class="term">管理</span></dt><dd><p>
<!--
      The capabilities available for administrators to monitor and control
      the server often change and improve in each major release.
-->
各メジャーリリースにおいて、管理者が利用できるサーバの監視、制御機能はよく変更、向上されます。
     </p></dd><dt><span class="term">SQL</span></dt><dd><p>
<!--
      Typically this includes new SQL command capabilities and not changes
      in behavior, unless specifically mentioned in the release notes.
-->
通常、これには新しいSQLコマンド機能が含まれます。
リリースノートに特に記載がない限りその動作には変更はありません。
     </p></dd><dt><span class="term">ライブラリAPI</span></dt><dd><p>
<!--
      Typically libraries like <application>libpq</application> only add new
      functionality, again unless mentioned in the release notes.
-->
繰り返しになりますが、リリースノートに記載がない場合のみですが、通常<span class="application">libpq</span>のようなライブラリには新しい機能が追加されるだけです。
     </p></dd><dt><span class="term">システムカタログ</span></dt><dd><p>
<!--
      System catalog changes usually only affect database management tools.
-->
システムカタログの変更は通常データベース管理用ツールにのみ影響します。
     </p></dd><dt><span class="term">サーバC言語API</span></dt><dd><p>
<!--
      This involves changes in the backend function API, which is written
      in the C programming language.  Such changes affect code that
      references backend functions deep inside the server.
-->
ここには、Cプログラム言語で作成されたバックエンド関数APIにおける変更が含まれます。
こうした変更は、サーバ内部深くにあるバックエンド関数を参照するコードに影響します。
     </p></dd></dl></div><div class="sect2" id="UPGRADING-VIA-PGDUMPALL"><div class="titlepage"><div><div><h3 class="title">18.6.1. <span class="application">pg_dumpall</span>を介したデータのアップグレード</h3></div></div></div><!--
   <title>Upgrading Data via <application>pg_dumpall</application></title>
--><p>
<!--
    One upgrade method is to dump data from one major version of
    <productname>PostgreSQL</productname> and reload it in another &mdash;  to do
    this, you must use a <emphasis>logical</emphasis> backup tool like
    <application>pg_dumpall</application>; file system
    level backup methods will not work. (There are checks in place that prevent
    you from using a data directory with an incompatible version of
    <productname>PostgreSQL</productname>, so no great harm can be done by
    trying to start the wrong server version on a data directory.)
-->
<span class="productname">PostgreSQL</span>のアップグレードの一つの方法は、<span class="productname">PostgreSQL</span>の１メジャーバージョンからデータをダンプし、別のバージョンにリロードすることです - これを行うには、<span class="application">pg_dumpall</span>のような<span class="emphasis"><em>論理</em></span>バックアップツールを使用しなければなりません。
ファイルシステムレベルのバックアップ方法は動作しません。
（あるデータディレクトリ間違ったバージョンのサーバを起動しようとして、大きな損害が起こることがないように、適所に互換性がないバージョンの<span class="productname">PostgreSQL</span>のデータディレクトリが使用されないようにするための検査があります。）
   </p><p>
<!--
    It is recommended that you use the <application>pg_dump</application> and
    <application>pg_dumpall</application> programs from the <emphasis>newer</emphasis>
    version of
    <productname>PostgreSQL</productname>, to take advantage of enhancements
    that might have been made in these programs.  Current releases of the
    dump programs can read data from any server version back to 7.0.
-->
新しいバージョンの<span class="productname">PostgreSQL</span>の<span class="application">pg_dump</span>と<span class="application">pg_dumpall</span>を使用することを勧めます。
これらのプログラムで拡張された機能を利用する可能性があるためです。
現在のリリースのダンププログラムは7.0以降のバージョンのサーバからデータを読み取ることができます。
   </p><p>
<!--
    These instructions assume that your existing installation is under the
    <filename>/usr/local/pgsql</filename> directory, and that the data area is in
    <filename>/usr/local/pgsql/data</filename>.  Substitute your paths
    appropriately.
-->
以下の手順では、既存のインストレーションが<code class="filename">/usr/local/pgsql</code>以下にあり、そのデータ領域が<code class="filename">/usr/local/pgsql/data</code>にあることを前提としています。
使用しているパスに適切に置き換えてください。
   </p><div class="procedure"><ol class="procedure" type="1"><li class="step"><p>
<!--
      If making a backup, make sure that your database is not being updated.
      This does not affect the integrity of the backup, but the changed
      data would of course not be included. If necessary, edit the
      permissions in the file <filename>/usr/local/pgsql/data/pg_hba.conf</filename>
      (or equivalent) to disallow access from everyone except you.
      See <xref linkend="client-authentication"/> for additional information on
      access control.
-->
バックアップを作成する場合、使用しているデータベースが確実に更新されないようにしてください。
これはバックアップの整合性には影響しませんが、当然ながら変更されたデータがバックアップに含まれません。
必要に応じて、<code class="filename">/usr/local/pgsql/data/pg_hba.conf</code>（またはこれと等価なファイル）における権限を変更して、バックアップを行うユーザ以外からのアクセスを禁止してください。
アクセス制御に関する情報は<a class="xref" href="client-authentication.html" title="第20章 クライアント認証">第20章</a>を参照してください。
     </p><p>
      <a id="id-1.6.5.8.11.5.1.2.1" class="indexterm"></a>

<!--
      To back up your database installation, type:
-->
データベースインストレーションをバックアップするためには以下を入力してください。
</p><pre class="screen">
<strong class="userinput"><code>pg_dumpall &gt; <em class="replaceable"><code>outputfile</code></em></code></strong>
</pre><p>
     </p><p>
<!--
      To make the backup, you can use the <application>pg_dumpall</application>
      command from the version you are currently running;  see <xref
      linkend="backup-dump-all"/> for more details.  For best
      results, however, try to use the <application>pg_dumpall</application>
      command from <productname>PostgreSQL</productname> &version;,
      since this version contains bug fixes and improvements over older
      versions.  While this advice might seem idiosyncratic since you
      haven't installed the new version yet, it is advisable to follow
      it if you plan to install the new version in parallel with the
      old version.  In that case you can complete the installation
      normally and transfer the data later.  This will also decrease
      the downtime.
-->
バックアップを作成するために、現在起動中のバージョンの<span class="application">pg_dumpall</span>コマンドを使用することができます。詳細は<a class="xref" href="backup-dump.html#BACKUP-DUMP-ALL" title="25.1.2. pg_dumpallの使用">25.1.2</a> を参照してください。
しかし最善の結果を得るためには、<span class="productname">PostgreSQL</span> 11.4の<span class="application">pg_dumpall</span>コマンドを試してください。
このバージョンでは、過去のバージョンに対して、不具合の修正や改良が含まれているからです。
新しいバージョンをまだインストールしていませんので、この勧告は奇異に思えるかもしれませんが、古いバージョンと並行して新しいバージョンをインストールすることを計画しているのであれば、これに従うことを推奨します。
この場合、インストールを普通に完了させてからデータを移行することができます。
これは同時に停止時間を短縮します。
     </p></li><li class="step"><p>
<!--
      Shut down the old server:
-->
古いサーバを停止します。
</p><pre class="screen">
<strong class="userinput"><code>pg_ctl stop</code></strong>
</pre><p>
<!--
      On systems that have <productname>PostgreSQL</productname> started at boot time,
      there is probably a start-up file that will accomplish the same thing. For
      example, on a <systemitem class="osname">Red Hat Linux</systemitem> system one
      might find that this works:
-->
起動時に<span class="productname">PostgreSQL</span>を実行させるようにしているシステムではおそらく、同じことを達成する起動ファイルがあります。
例えば<span class="systemitem">Red Hat Linux</span>システムでは、以下が動作することが分かります。
</p><pre class="screen">
<strong class="userinput"><code>/etc/rc.d/init.d/postgresql stop</code></strong>
</pre><p>
<!--
      See <xref linkend="runtime"/> for details about starting and
      stopping the server.
-->
サーバの起動と停止については<a class="xref" href="runtime.html" title="第18章 サーバの準備と運用">第18章</a>を参照してください。
     </p></li><li class="step"><p>
<!--
      If restoring from backup, rename or delete the old installation
      directory if it is not version-specific.  It is a good idea to
      rename the directory, rather than
      delete it, in case you have trouble and need to revert to it.  Keep
      in mind the directory might consume significant disk space.  To rename
      the directory, use a command like this:
-->
バックアップからリストアする場合、名前を変更、またはバージョン固有でない場合は古いインストレーションディレクトリを削除してください。
問題があった場合に戻さなければならない場合に備え、削除するよりディレクトリの名前を変更する方を勧めます。
このディレクトリが多くのディスク容量を占めている可能性があることに注意してください。
ディレクトリの名前を変更するためには、以下のようなコマンドを使用してください。
</p><pre class="screen">
<strong class="userinput"><code>mv /usr/local/pgsql /usr/local/pgsql.old</code></strong>
</pre><p>
<!--
     (Be sure to move the directory as a single unit so relative paths
     remain unchanged.)
-->
（相対パスが維持されるように確実にディレクトリ単位で移動してください。）
     </p></li><li class="step"><p>
<!--
      Install the new version of <productname>PostgreSQL</productname> as
      outlined in <xref linkend="install-procedure"/>.
-->
概要を<a class="xref" href="install-procedure.html" title="16.4. インストール手順">16.4</a>で示すように、新しいバージョンの<span class="productname">PostgreSQL</span>をインストールしてください。
     </p></li><li class="step"><p>
<!--
      Create a new database cluster if needed.  Remember that you must
      execute these commands while logged in to the special database user
      account (which you already have if you are upgrading).
-->
必要に応じて新しいデータベースクラスタを作成してください。
（アップグレードの場合はすでに存在している）特別なデータベースユーザアカウントでログインして、このコマンドを実行しなければならないことに注意してください。
</p><pre class="programlisting">
<strong class="userinput"><code>/usr/local/pgsql/bin/initdb -D /usr/local/pgsql/data</code></strong>
</pre><p>
     </p></li><li class="step"><p>
<!--
      Restore your previous <filename>pg_hba.conf</filename> and any
      <filename>postgresql.conf</filename> modifications.
-->
以前の<code class="filename">pg_hba.conf</code>と<code class="filename">postgresql.conf</code>に加えた何らかの変更を戻してください。
     </p></li><li class="step"><p>
<!--
      Start the database server, again using the special database user
      account:
-->
繰り返しになりますが、特別なデータベースユーザアカウントを使用して、データベースサーバを起動してください。
</p><pre class="programlisting">
<strong class="userinput"><code>/usr/local/pgsql/bin/postgres -D /usr/local/pgsql/data</code></strong>
</pre><p>
     </p></li><li class="step"><p>
<!--
      Finally, restore your data from backup with:
-->
最後に、<span class="emphasis"><em>新しい</em></span><span class="application">psql</span>を用いて、バックアップからデータをリストアしてください。
</p><pre class="screen">
<strong class="userinput"><code>/usr/local/pgsql/bin/psql -d postgres -f <em class="replaceable"><code>outputfile</code></em></code></strong>
</pre><p>
      using the <span class="emphasis"><em>new</em></span> <span class="application">psql</span>.
     </p></li></ol></div><p>
<!--
    The least downtime can be achieved by installing the new server in
    a different directory and running both the old and the new servers
    in parallel, on different ports. Then you can use something like:
-->
新しいサーバを異なるディレクトリにインストールし、古いサーバと新しいサーバを別のポートで並行して実行させることで、停止時間を最小にすることができます。
この場合、データを移行するために以下のようなコマンドを使用することができます。

</p><pre class="programlisting">
pg_dumpall -p 5432 | psql -d postgres -p 5433
</pre><p>
<!--
    to transfer your data.
-->
   </p></div><div class="sect2" id="UPGRADING-VIA-PG-UPGRADE"><div class="titlepage"><div><div><h3 class="title">18.6.2. <span class="application">pg_upgrade</span>を使用したアップグレード方法</h3></div></div></div><!--
   <title>Upgrading Data via <application>pg_upgrade</application></title>
--><p>
<!--
    The <xref linkend="pgupgrade"/> module allows an installation to
    be migrated in-place from one major <productname>PostgreSQL</productname>
    version to another.  Upgrades can be performed in minutes,
    particularly with <option>&#045;&#045;link</option> mode.  It requires steps similar to
    <application>pg_dumpall</application> above, e.g.  starting/stopping the server,
    running <application>initdb</application>.  The <application>pg_upgrade</application> <link
    linkend="pgupgrade">documentation</link> outlines the necessary steps.
-->
<a class="xref" href="pgupgrade.html" title="pg_upgrade"><span class="refentrytitle"><span class="application">pg_upgrade</span></span></a>モジュールにより、<span class="productname">PostgreSQL</span>のあるバージョンから次のバージョンにインストレーションをその場で移行することができます。
特に<code class="option">--link</code>オプションを使用することで、アップグレードは数分で行うことができます。
これは、<span class="application">pg_dumpall</span>と同様の工程を必要とします。
例えば、<span class="application">initdb</span>を実行し、サーバの起動／停止をおこないます。
<span class="application">pg_upgrade</span> <a class="link" href="pgupgrade.html" title="pg_upgrade">ドキュメント</a>で必要な手順を説明します。
   </p></div><div class="sect2" id="UPGRADING-VIA-REPLICATION"><div class="titlepage"><div><div><h3 class="title">18.6.3. レプリケーション経由のアップグレード</h3></div></div></div><!--
   <title>Upgrading Data via Replication</title>
--><p>
<!--
    It is also possible to use logical replication methods to create a standby
    server with the updated version of <productname>PostgreSQL</productname>.
    This is possible because logical replication supports
    replication between different major versions of
    <productname>PostgreSQL</productname>.  The standby can be on the same computer or
    a different computer.  Once it has synced up with the master server
    (running the older version of <productname>PostgreSQL</productname>), you can
    switch masters and make the standby the master and shut down the older
    database instance.  Such a switch-over results in only several seconds
    of downtime for an upgrade.
-->
論理レプリケーションを使って更新対象のバージョンの<span class="productname">PostgreSQL</span>をスタンバイサーバとして作成することもできます。
論理レプリケーションが異なるメジャーバージョンの<span class="productname">PostgreSQL</span>の間でレプリケーションすることができるため、これが実現できます。
スタンバイは同じコンピュータで作成することも異なるコンピュータで作成することもできます。
（古いバージョンの<span class="productname">PostgreSQL</span>で実行している）マスタサーバと同期した後、マスタを切り替え、スタンバイをマスタにし、古いデータベースインスタンスを停止することができます。
このようなスイッチオーバの結果、数秒の停止時間でアップグレードされます。
   </p><p>
<!--
    This method of upgrading can be performed using the built-in logical
    replication facilities as well as using external logical replication
    systems such as <productname>pglogical</productname>,
    <productname>Slony</productname>, <productname>Londiste</productname>, and
    <productname>Bucardo</productname>.
-->
この方法によるアップグレードは、組み込みの論理レプリケーション機能か、あるいは<span class="productname">pglogical</span>、<span class="productname">Slony</span>、<span class="productname">Londiste</span>、<span class="productname">Bucardo</span>などの外部の論理レプリケーションシステムを使うことで実施できます。
   </p></div></div><div class="navfooter"><hr /><table width="100%" summary="Navigation footer"><tr><td width="40%" align="left"><a accesskey="p" href="server-shutdown.html">前へ</a> </td><td width="20%" align="center"><a accesskey="u" href="runtime.html">上へ</a></td><td width="40%" align="right"> <a accesskey="n" href="preventing-server-spoofing.html">次へ</a></td></tr><tr><td width="40%" align="left" valign="top">18.5. サーバのシャットダウン </td><td width="20%" align="center"><a accesskey="h" href="index.html">ホーム</a></td><td width="40%" align="right" valign="top"> 18.7. サーバのなりすまし防止</td></tr></table></div></body></html>